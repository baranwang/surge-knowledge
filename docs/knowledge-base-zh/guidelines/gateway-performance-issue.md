Surge 网关模式性能问题排查指南
==================

该文档给出了当使用 Surge Mac 作为网关模式遇到性能问题时的排查指南。

### 

[](#chang-jian-wen-ti)

常见问题

请先排除以下常见问题

*   无线网络
    

请务必使用有线方式连接，网关设备使用无线接入将严重影响性能。

*   MTU 设置
    

请勿配置 Jumbo MTU，虽然 Surge 完整支持 Jumbo MTU，但是依然有很多设备在 Jumbo MTU 下可能出现问题。请至少在排查阶段关闭 Jumbo MTU。

*   10Gb 网络
    

目前已观察到多起在 10Gb 网络下出现性能异常的案例，这些问题多在 10Gb 设备和 1000Mbps 设备混用网络下出现，疑似与 TCP 拥堵控制和速率不匹配时的丢包策略有关。若使用 10Gb 网络，建议在排查阶段先强制调整至 1000Mbps。

（该问题并非 Surge Mac 特有问题，在各种操作系统和网络设备上均有故障报告，如确认是该问题，可尝试更换交换机和网络适配器。）

### 

[](#xing-neng-pai-cha-bu-zhou)

性能排查步骤

1.  外网性能测试
    

首先应测试外网速度是否符合预期，在用做网关的设备上关闭 Surge，运行各类网速测试工具，如 [SpeedTest](https://www.speedtest.net/)、[WiFiman](https://wifiman.com/) 等。如果外网速度不及预期，请排查路由器、交换和网线，可联系 ISP 工作人员协助排查。

1.  内网设备间链路测试
    

应测试内网设备与用做网关设备间的链路速度，可使用 iperf3 进行测试。为避免无线网络的各种复杂干扰，推荐使用有线设备进行测试。千兆网络下双向速度应达到 900Mbps+。

1.  网关设备性能测试
    

在用做网关的设备上开启 Surge，新建一份空白配置以避免干扰，再次运行各类网速测试工具，测试结果应于步骤 1 的结果一致，如果偏低，建议在测试时同步观察系统的 CPU 使用情况。Surge 有着非常优异的性能优化，在最近 5 年内生产的 Mac 设备上均不太可能遇到设备硬件性能瓶颈（千兆网络下），如确认是该问题请尝试重装操作系统后再试。

1.  代理性能测试
    

若使用了加密的代理，应在 Surge 中配置代理后，使用全局代理模式配合网速测试工具再次进行网速测试。该步骤的结果受两个因素限制：代理服务器线路带宽和网关设备性能。同样的，Surge 有着非常优异的性能优化，在最近 5 年内生产的 Mac 设备上均不太可能因设备硬件性能而限制了网速（千兆网络下），如确认是该问题请尝试重装操作系统后再试。